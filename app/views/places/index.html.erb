<h2>All places</h2>

  <div class="content" style="padding-left: 300px;">

  </div>  
  <div style="padding-top: 400px;">
    <%= form_tag places_search_path, method: :get, remote: true do |f| %>
        <p>
          <%= text_field_tag :search, params[:search] %>
          <%= submit_tag "Search", name: nil %>
        </p>
    <% end %>
    <div id="my_search">
      <p><strong>Nearby me</strong></p>
    </div>
    <div id="search_places">
      <%= render 'place' %>
    </div>
  </div>
  <div>
    <input type='button' value='go' id="goto_list"/>
  </div>
<script>
  $(document).ready(function() {
      var places = gon.places;
      var number_of_places = places.length;
      var initial_number = 0;
      var saved_list = [];
      
       addNewProfile();
       $("#goto_list").click(function(){
        if(saved_list.length <= 0){
          alert("you haven't liked any place yet...")
        }
        else{
          $.ajax({
              method: 'post',
              url: '/favourite_lists',
              beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
              data: {places_id: saved_list}
              });
        }
       });
       function swipe() {
         Draggable.create("#photo", {
             throwProps:true,
             onDragEnd:function(endX) {
                initial_number++    
               if(Math.round(this.endX) > 0 ) {
                 swipeLike();
               }
               else {
                 swipeDislike();
               }
           },
           onClick:function(){
            var currentPlace = places[initial_number]
            var full = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
            // console.log(initial_number + ":" + places[initial_number].name);
            window.location.href = full+"/places/"+currentPlace.id;
           }
         });
       }

       function swipeLike() {
         
           var $photo = $("div.content").find('#photo');

           var swipe = new TimelineMax({repeat:0, yoyo:false, repeatDelay:0, onComplete:remove, onCompleteParams:[$photo]});
           swipe.staggerTo($photo, 0.8, {bezier:[{left:"+=400", top:"+=300", rotation:"60"}], ease:Power1.easeInOut});
           
           saved_list.push(places[initial_number-1].id)
           addNewProfile();
       }

       function swipeDislike() {
         
           var $photo = $("div.content").find('#photo');

           var swipe = new TimelineMax({repeat:0, yoyo:false, repeatDelay:0, onComplete:remove, onCompleteParams:[$photo]});
           swipe.staggerTo($photo, 0.8, {bezier:[{left:"+=-350", top:"+=300", rotation:"-60"}], ease:Power1.easeInOut});
           addNewProfile();
       }

       function remove(photo) {
           $(photo).remove();
       }

       function addNewProfile() {
        if(initial_number < number_of_places ){
          var url = places[initial_number].avatars[0].url
          $("div.content").prepend("<div class='photo' id='photo' style='background-image:url("+url+")''>"
            + '<span class="meta">' 
            + places[initial_number].name
            + '</span>' 
            + '</div>');
            swipe();
        }
        else{
          alert("finish")
        }
       };
       
     });
</script>